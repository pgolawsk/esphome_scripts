---
#* Water usage sensors using YF-B10 valve configuration
# Pawelo, 20230111, created based on https://www.pieterbrinkman.com/2022/02/02/build-a-cheap-water-usage-sensor-using-esphome-home-assistant-and-a-proximity-sensor/


platform: pulse_counter
  pin: GPIO12
  name: "water pulse"
  id: water_pulse
  update_interval: $updates
  internal: true

platform: pulse_meter
  pin: GPIO12
  name: "$room Water Pulse Meter"
  unit_of_measurement: "liter/min"
  icon: "mdi:water"
  total:
    name: "$room Water Total"
    unit_of_measurement: "liter"

platform: pulse_meter
  pin: GPIO12
  name: "$room Water Pulse Meter"
  unit_of_measurement: "liter/min"
  icon: "mdi:water"
  total:
    name: "$room Water Meter Total"
    unit_of_measurement: "mÂ³"
    id: water_meter_total
    accuracy_decimals: 3
    device_class: water
    state_class: total_increasing
    filters:
      - multiply: 0.001

platform: template
  name: "$room Water Flow"
  id: water_flow
  accuracy_decimals: 2
  unit_of_measurement: "l/min"
  icon: "mdi:water"
  lambda: return (id(water_pulse).state / 476);
  state_topic: $devicename/water_flow
  on_value:
    - mqtt.publish:
        topic: "$mqtt_location/$mqtt_room/water_flow"
        payload: !lambda |-
          return to_string(id(water_flow).state);
  update_interval: $updates
