---
#* Water usage sensors using YF-B10 valve configuration
# Pawelo, 20230111, created based on https://www.pieterbrinkman.com/2022/02/02/build-a-cheap-water-usage-sensor-using-esphome-home-assistant-and-a-proximity-sensor/
# Pawelo, 20230121, final configuration with real sensor
# TODO: calibrate sensor on water, based on https://community.home-assistant.io/t/using-esphome-to-build-a-water-flow-rate-meter/119380/75
# CALIBRATION DONE: Looks like sensor measures  flow of 1.3L/min at minimum, so very slow move is not detected

platform: pulse_meter
pin:
  number: ${gpio}
#  number: GPIO12
  mode: INPUT_PULLUP
id: water_flow${ix}
icon: "mdi:water"
name: "$room Water Flow${ix}"
unit_of_measurement: "liter/min"
timeout: $updates
internal: true
state_topic: $devicename/water_flow${ix}
on_value:
  - mqtt.publish:
      topic: "$mqtt_location/$mqtt_room/water_flow${ix}"
      payload: !lambda |-
        return to_string(x);
filters:
  - lambda: return x / ${pulses_per_liter};
  - clamp:
      min_value: 0
      max_value: 80
total:
  name: "$room Water Total${ix}"
  id: water_total${ix}
  icon: "mdi:water-plus"
  unit_of_measurement: "liter"
#      unit_of_measurement: "mÂ³"
  accuracy_decimals: 2
  device_class: water
  state_class: total_increasing
  state_topic: $devicename/water_total${ix}
  filters:
    - lambda: if (isnan(x)) { return 0; } return x / ${pulses_per_liter};
#        - multiply: 0.001
  on_value:
    - mqtt.publish:
        topic: "$mqtt_location/$mqtt_room/water_total${ix}"
        payload: !lambda |-
          return to_string(x);
